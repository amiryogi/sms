// =====================================================
// K-12 SCHOOL MANAGEMENT SYSTEM - PRISMA SCHEMA
// MySQL 8.0+ | Prisma 5.x
// =====================================================
// 
// This schema supports:
// - Single-school initially, expandable to multi-school
// - Full RBAC (Roles, Permissions, RolePermissions, UserRoles)
// - All K-12 academic management features
// - JWT authentication with refresh tokens
//
// =====================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum UserStatus {
  active
  inactive
  suspended
}

enum Gender {
  male
  female
  other
}

enum StudentClassStatus {
  active
  transferred
  graduated
  dropped
}

enum AttendanceStatus {
  present
  absent
  late
  excused
}

enum ExamType {
  unit_test
  midterm
  final
  board
}

enum SubmissionStatus {
  submitted
  late
  graded
  returned
}

enum PromotionStatus {
  promoted
  detained
  graduated
}

enum Relationship {
  father
  mother
  guardian
}

enum TargetAudience {
  all
  students
  parents
  teachers
}

enum NoticePriority {
  low
  normal
  high
  urgent
}

enum NoticeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum NoticeTargetType {
  GLOBAL          // School-wide, all roles see it
  ROLE_SPECIFIC   // Only specific role(s)
  CLASS_SPECIFIC  // Only specific class(es)
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  LOCKED
}

enum PaymentStatus {
  pending
  partial
  paid
}

// NEB (Nepal Education Board) component types for Grade 11-12
enum ComponentType {
  THEORY
  PRACTICAL
}

// Student subject enrollment status (Grade 11-12)
enum StudentSubjectStatus {
  ACTIVE
  DROPPED
}

// Subject audit action types
enum SubjectAuditAction {
  CREATE
  UPDATE
  LOCK
  DELETE
}

// =====================================================
// CORE: SCHOOLS (Multi-school Ready)
// =====================================================

/// Schools table - core entity for multi-school support
model School {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  code      String   @unique @db.VarChar(50)
  address   String?  @db.Text
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(255)
  logoUrl   String?  @map("logo_url") @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Extended school branding fields
  tagline         String?  @db.VarChar(500)
  website         String?  @db.VarChar(255)
  bannerUrl       String?  @map("banner_url") @db.VarChar(500)
  landlineNumber  String?  @map("landline_number") @db.VarChar(30)
  facebookUrl     String?  @map("facebook_url") @db.VarChar(500)
  instagramUrl    String?  @map("instagram_url") @db.VarChar(500)
  youtubeUrl      String?  @map("youtube_url") @db.VarChar(500)
  principalName   String?  @map("principal_name") @db.VarChar(255)
  establishedYear Int?     @map("established_year")

  // Relations
  users         User[]
  academicYears AcademicYear[]
  classes       Class[]
  sections      Section[]
  subjects      Subject[]
  exams         Exam[]
  notices       Notice[]
  students      Student[]
  parents       Parent[]
  studentClasses StudentClass[]
  studentParents StudentParent[]
  attendances    Attendance[]
  submissions    Submission[]
  examResults    ExamResult[]
  feeTypes       FeeType[]
  feeStructures  FeeStructure[]
  feePayments    FeePayment[]
  programs       Program[]

  @@index([code])
  @@index([isActive])
  @@map("schools")
}

// =====================================================
// RBAC: ROLES
// =====================================================

/// Roles for RBAC (SUPER_ADMIN, ADMIN, TEACHER, STUDENT, PARENT)
model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userRoles         UserRole[]
  rolePermissions   RolePermission[]
  noticeRoleTargets NoticeRoleTarget[]

  @@index([name])
  @@map("roles")
}

// =====================================================
// RBAC: PERMISSIONS
// =====================================================

/// Permissions define granular access controls
model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  module      String   @db.VarChar(50)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([name])
  @@index([module])
  @@map("permissions")
}

// =====================================================
// RBAC: ROLE_PERMISSIONS (Many-to-Many)
// =====================================================

/// Maps roles to permissions
model RolePermission {
  id           Int      @id @default(autoincrement())
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// =====================================================
// USERS
// =====================================================

/// Main user table - all system users (admins, teachers, students, parents)
model User {
  id           Int        @id @default(autoincrement())
  schoolId     Int        @map("school_id")
  email        String     @db.VarChar(255)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  firstName    String     @map("first_name") @db.VarChar(100)
  lastName     String     @map("last_name") @db.VarChar(100)
  phone        String?    @db.VarChar(20)
  avatarUrl    String?    @map("avatar_url") @db.VarChar(500)
  status       UserStatus @default(active)
  lastLogin    DateTime?  @map("last_login")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  student         Student?
  parent          Parent?
  teacherSubjects TeacherSubject[]
  refreshTokens   RefreshToken[]

  // Attendance marked by this user (teacher)
  attendanceMarked Attendance[] @relation("MarkedBy")

  // Exam results entered by this user (teacher)
  examResultsEntered ExamResult[] @relation("EnteredBy")

  // Exams created by this user (admin)
  examsCreated Exam[] @relation("ExamsCreated")

  // Submissions graded by this user (teacher)
  submissionsGraded Submission[] @relation("GradedBy")

  // Notices created by this user
  noticesCreated Notice[] @relation("NoticeCreatedBy")

  // Promotions processed by this user (admin)
  promotionsProcessed Promotion[] @relation("ProcessedBy")

  // Fee audit relations
  feeTypesCreated      FeeType[]      @relation("FeeTypeCreatedBy")
  feeTypesUpdated      FeeType[]      @relation("FeeTypeUpdatedBy")
  feeStructuresCreated FeeStructure[] @relation("FeeStructureCreatedBy")
  feeStructuresUpdated FeeStructure[] @relation("FeeStructureUpdatedBy")
  feePaymentsCreated   FeePayment[]   @relation("FeePaymentCreatedBy")
  feePaymentsUpdated   FeePayment[]   @relation("FeePaymentUpdatedBy")
  feePaymentsRecorded  FeePayment[]   @relation("FeePaymentRecordedBy")

  @@unique([email, schoolId])
  @@index([schoolId])
  @@index([email])
  @@index([status])
  @@index([firstName, lastName])
  @@map("users")
}

// =====================================================
// USER_ROLES (Many-to-Many)
// =====================================================

/// Maps users to roles
model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// =====================================================
// ACADEMIC_YEARS
// =====================================================

/// Academic years (e.g., 2024-2025)
model AcademicYear {
  id        Int      @id @default(autoincrement())
  schoolId  Int      @map("school_id")
  name      String   @db.VarChar(50)
  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date
  isCurrent Boolean  @default(false) @map("is_current")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classSubjects      ClassSubject[]
  studentClasses     StudentClass[]
  teacherSubjects    TeacherSubject[]
  exams              Exam[]
  promotionsFrom     Promotion[]         @relation("FromYear")
  promotionsTo       Promotion[]         @relation("ToYear")
  noticeClassTargets NoticeClassTarget[]
  feeStructures      FeeStructure[]
  programs           Program[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([isCurrent])
  @@index([startDate, endDate])
  @@map("academic_years")
}

// =====================================================
// CLASSES
// =====================================================

/// Grade/Class levels (e.g., Grade 1, Grade 2, etc.)
model Class {
  id           Int      @id @default(autoincrement())
  schoolId     Int      @map("school_id")
  name         String   @db.VarChar(50)
  gradeLevel   Int      @map("grade_level")
  description  String?  @db.Text
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classSubjects      ClassSubject[]
  studentClasses     StudentClass[]
  promotionsFrom     Promotion[]         @relation("FromClass")
  promotionsTo       Promotion[]         @relation("ToClass")
  noticeClassTargets NoticeClassTarget[]
  feeStructures      FeeStructure[]
  subjectComponents  SubjectComponent[]  // NEB Grade 11-12 components

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("classes")
}

// =====================================================
// SECTIONS
// =====================================================

/// Sections within classes (e.g., Section A, B, C)
model Section {
  id        Int      @id @default(autoincrement())
  schoolId  Int      @map("school_id")
  name      String   @db.VarChar(10)
  capacity  Int      @default(40)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacherSubjects    TeacherSubject[]
  studentClasses     StudentClass[]
  noticeClassTargets NoticeClassTarget[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("sections")
}

// =====================================================
// SUBJECTS (Master List)
// =====================================================

/// Master list of subjects per school
model Subject {
  id          Int      @id @default(autoincrement())
  schoolId    Int      @map("school_id")
  name        String   @db.VarChar(100)
  code        String   @db.VarChar(20)
  description String?  @db.Text
  isOptional   Boolean  @default(false) @map("is_optional")
  creditHours  Decimal  @default(3.0) @map("credit_hours") @db.Decimal(3, 1)
  hasPractical Boolean  @default(false) @map("has_practical")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  school            School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classSubjects     ClassSubject[]
  subjectComponents SubjectComponent[] // NEB Grade 11-12 components

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([code])
  @@map("subjects")
}

// =====================================================
// SUBJECT_COMPONENTS (NEB Grade 11-12 Only)
// =====================================================

/// NEB-compliant subject components for Grade 11-12
/// Theory and Practical are SEPARATE assessment components
/// Each component has its own subject code, marks, and credit hours
model SubjectComponent {
  id          Int           @id @default(autoincrement())
  subjectId   Int           @map("subject_id")
  classId     Int           @map("class_id")
  type        ComponentType
  subjectCode String        @map("subject_code") @db.VarChar(20)
  fullMarks   Int           @map("full_marks")
  passMarks   Int           @map("pass_marks")
  creditHours Float         @map("credit_hours")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId, type])
  @@index([subjectId])
  @@index([classId])
  @@map("subject_components")
}

// =====================================================
// CLASS_SUBJECTS (Dynamic Subjects per Class per Year)
// =====================================================

/// Links subjects to classes for specific academic years
/// IMPORTANT: hasTheory/hasPractical control evaluation structure per class
model ClassSubject {
  id                   Int      @id @default(autoincrement())
  classId              Int      @map("class_id")
  academicYearId       Int      @map("academic_year_id")
  subjectId            Int      @map("subject_id")
  hasTheory            Boolean  @default(true) @map("has_theory")
  hasPractical         Boolean  @default(false) @map("has_practical")
  fullMarks            Int      @default(100) @map("full_marks")
  passMarks            Int      @default(40) @map("pass_marks")
  theoryMarks          Int      @default(100) @map("theory_marks")
  practicalMarks       Int      @default(0) @map("practical_marks")
  creditHours          Decimal  @default(3.0) @map("credit_hours") @db.Decimal(3, 1)
  theoryCreditHours    Decimal? @default(0) @map("theory_credit_hours") @db.Decimal(4, 2)
  practicalCreditHours Decimal? @default(0) @map("practical_credit_hours") @db.Decimal(4, 2)
  isLocked             Boolean  @default(false) @map("is_locked")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  class           Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  subject         Subject          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherSubjects  TeacherSubject[]
  examSubjects     ExamSubject[]
  programSubjects  ProgramSubject[]
  studentSubjects  StudentSubject[]

  @@unique([classId, academicYearId, subjectId])
  @@index([classId])
  @@index([academicYearId])
  @@index([subjectId])
  @@index([classId, academicYearId])
  @@map("class_subjects")
}

// =====================================================
// TEACHER_SUBJECTS (Teacher Assignments)
// =====================================================

/// Assigns teachers to class+section+subject combinations
/// Note: academicYearId is denormalized for easier querying
model TeacherSubject {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  classSubjectId Int      @map("class_subject_id")
  sectionId      Int      @map("section_id")
  academicYearId Int      @map("academic_year_id")
  isClassTeacher Boolean  @default(false) @map("is_class_teacher")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)
  section      Section      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  assignments  Assignment[]

  // Ensure the same teacher can be reassigned across academic years without clashes,
  // while still scoping uniqueness per year to avoid duplicate rows in the same cycle.
  @@unique([userId, classSubjectId, sectionId, academicYearId])
  @@index([userId])
  @@index([classSubjectId])
  @@index([sectionId])
  @@index([academicYearId])
  @@index([classSubjectId, academicYearId])
  @@map("teacher_subjects")
}

// =====================================================
// STUDENTS (Extended Profile)
// =====================================================

/// Student profile linked to User
model Student {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  schoolId         Int      @default(1) @map("school_id")
  admissionNumber  String   @map("admission_number") @db.VarChar(50)
  dateOfBirth      DateTime @map("date_of_birth") @db.Date
  gender           Gender
  bloodGroup       String?  @map("blood_group") @db.VarChar(5)
  address          String?  @db.Text
  emergencyContact String?  @map("emergency_contact") @db.VarChar(20)
  admissionDate    DateTime @map("admission_date") @db.Date
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  school         School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentClasses StudentClass[]
  studentParents StudentParent[]
  attendances    Attendance[]
  examResults    ExamResult[]
  submissions    Submission[]
  reportCards    ReportCard[]
  promotions     Promotion[]

  @@index([userId])
  @@index([admissionNumber])
  @@index([dateOfBirth])
  @@index([schoolId])
  @@map("students")
}

// =====================================================
// STUDENT_CLASSES (Enrollment per Academic Year)
// =====================================================

/// Enrollment records - links students to class/section per academic year
model StudentClass {
  id             Int                @id @default(autoincrement())
  studentId      Int                @map("student_id")
  classId        Int                @map("class_id")
  sectionId      Int                @map("section_id")
  academicYearId Int                @map("academic_year_id")
  schoolId       Int                @default(1) @map("school_id")
  rollNumber     Int?               @map("roll_number")
  status         StudentClassStatus @default(active)
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  section      Section      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  attendances  Attendance[]
  reportCards  ReportCard[]
  examResults  ExamResult[]
  submissions     Submission[]
  feePayments     FeePayment[]
  studentProgram  StudentProgram?
  studentSubjects StudentSubject[]

  @@unique([studentId, academicYearId])
  @@index([studentId])
  @@index([classId])
  @@index([sectionId])
  @@index([academicYearId])
  @@index([status])
  @@index([classId, sectionId, academicYearId])
  @@index([schoolId])
  @@map("student_classes")
}

// =====================================================
// PARENTS (Extended Profile)
// =====================================================

/// Parent/Guardian profile linked to User
model Parent {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique @map("user_id")
  schoolId   Int      @default(1) @map("school_id")
  occupation String?  @db.VarChar(100)
  workplace  String?  @db.VarChar(255)
  address    String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  school         School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentParents StudentParent[]

  @@index([userId])
  @@index([schoolId])
  @@map("parents")
}

// =====================================================
// STUDENT_PARENTS (Many-to-Many)
// =====================================================

/// Links students to parents with relationship type
model StudentParent {
  id           Int          @id @default(autoincrement())
  studentId    Int          @map("student_id")
  parentId     Int          @map("parent_id")
  schoolId     Int          @default(1) @map("school_id")
  relationship Relationship
  isPrimary    Boolean      @default(false) @map("is_primary")
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relations
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
  @@index([schoolId])
  @@map("student_parents")
}

// =====================================================
// ATTENDANCE
// =====================================================

/// Daily attendance records per student
/// Unique constraint includes studentClassId to handle re-enrollments
model Attendance {
  id             Int              @id @default(autoincrement())
  studentClassId Int              @map("student_class_id")
  studentId      Int              @map("student_id")
  schoolId       Int              @default(1) @map("school_id")
  attendanceDate DateTime         @map("attendance_date") @db.Date
  status         AttendanceStatus
  remarks        String?          @db.Text
  markedBy       Int              @map("marked_by")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relations
  studentClass StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  markedByUser User         @relation("MarkedBy", fields: [markedBy], references: [id], onDelete: Restrict)

  // FIXED: Unique constraint now includes studentClassId
  @@unique([studentId, studentClassId, attendanceDate])
  @@index([studentClassId])
  @@index([studentId])
  @@index([attendanceDate])
  @@index([status])
  @@index([markedBy])
  @@index([studentId, attendanceDate])
  @@index([schoolId])
  @@map("attendance")
}

// =====================================================
// EXAMS
// =====================================================

/// Exam definitions (Unit Test, Midterm, Final, Board)
model Exam {
  id             Int         @id @default(autoincrement())
  schoolId       Int         @map("school_id")
  academicYearId Int         @map("academic_year_id")
  name           String      @db.VarChar(100)
  examType       ExamType    @map("exam_type")
  status         ExamStatus  @default(DRAFT)
  createdBy      Int         @map("created_by")
  startDate      DateTime?   @map("start_date") @db.Date
  endDate        DateTime?   @map("end_date") @db.Date
  publishedAt    DateTime?   @map("published_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  createdByUser User          @relation("ExamsCreated", fields: [createdBy], references: [id], onDelete: Restrict)
  examSubjects  ExamSubject[]
  reportCards   ReportCard[]

  @@index([schoolId])
  @@index([academicYearId])
  @@index([examType])
  @@index([status])
  @@index([createdBy])
  @@index([startDate, endDate])
  @@map("exams")
}

// =====================================================
// EXAM_SUBJECTS
// =====================================================

/// Links exams to class subjects with schedule
/// IMPORTANT: hasTheory/hasPractical are snapshots copied from ClassSubject at exam creation time
model ExamSubject {
  id             Int       @id @default(autoincrement())
  examId         Int       @map("exam_id")
  classSubjectId Int       @map("class_subject_id")
  examDate       DateTime? @map("exam_date") @db.Date
  startTime      DateTime? @map("start_time") @db.Time()
  endTime        DateTime? @map("end_time") @db.Time()
  hasTheory          Boolean   @default(true) @map("has_theory")
  hasPractical       Boolean   @default(false) @map("has_practical")
  fullMarks          Int       @map("full_marks")
  passMarks          Int       @map("pass_marks")
  theoryFullMarks    Int       @default(100) @map("theory_full_marks")
  practicalFullMarks Int       @default(0) @map("practical_full_marks")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  exam         Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)
  examResults  ExamResult[]

  @@unique([examId, classSubjectId])
  @@index([examId])
  @@index([classSubjectId])
  @@index([examDate])
  @@map("exam_subjects")
}

// =====================================================
// EXAM_RESULTS
// =====================================================

/// Stores student marks per exam subject
model ExamResult {
  id             Int      @id @default(autoincrement())
  examSubjectId  Int      @map("exam_subject_id")
  studentId      Int      @map("student_id")
  studentClassId Int      @map("student_class_id")
  schoolId       Int      @default(1) @map("school_id")
  marksObtained  Decimal? @map("marks_obtained") @db.Decimal(5, 2)
  practicalMarks Decimal? @default(0) @map("practical_marks") @db.Decimal(5, 2)
  isAbsent       Boolean  @default(false) @map("is_absent")
  grade          String?  @db.VarChar(5)
  remarks        String?  @db.Text
  enteredBy      Int      @map("entered_by")
  enteredByRole  String   @default("TEACHER") @map("entered_by_role") @db.VarChar(20)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  examSubject   ExamSubject @relation(fields: [examSubjectId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentClass  StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  school        School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  enteredByUser User        @relation("EnteredBy", fields: [enteredBy], references: [id], onDelete: Restrict)

  @@unique([examSubjectId, studentId])
  @@index([examSubjectId])
  @@index([studentId])
  @@index([studentClassId])
  @@index([enteredBy])
  @@index([grade])
  @@index([schoolId])
  @@map("exam_results")
}

// =====================================================
// REPORT_CARDS
// =====================================================

/// Generated report cards per student per exam
/// Note: "rank" renamed to "classRank" to avoid MySQL reserved keyword
model ReportCard {
  id               Int       @id @default(autoincrement())
  studentId        Int       @map("student_id")
  examId           Int       @map("exam_id")
  studentClassId   Int       @map("student_class_id")
  totalMarks       Decimal?  @map("total_marks") @db.Decimal(7, 2)
  percentage       Decimal?  @db.Decimal(5, 2)
  overallGrade     String?   @map("overall_grade") @db.VarChar(5)
  classRank        Int?      @map("class_rank")
  teacherRemarks   String?   @map("teacher_remarks") @db.Text
  principalRemarks String?   @map("principal_remarks") @db.Text
  isPublished      Boolean   @default(false) @map("is_published")
  generatedAt      DateTime? @map("generated_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam         Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentClass StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId])
  @@index([studentId])
  @@index([examId])
  @@index([studentClassId])
  @@index([isPublished])
  @@index([classRank])
  @@map("report_cards")
}

// =====================================================
// ASSIGNMENTS
// =====================================================

/// Homework/assignments created by teachers
model Assignment {
  id               Int      @id @default(autoincrement())
  teacherSubjectId Int      @map("teacher_subject_id")
  title            String   @db.VarChar(255)
  description      String?  @db.Text
  dueDate          DateTime @map("due_date") @db.Date
  totalMarks       Int      @default(100) @map("total_marks")
  isPublished      Boolean  @default(false) @map("is_published")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  teacherSubject  TeacherSubject   @relation(fields: [teacherSubjectId], references: [id], onDelete: Cascade)
  assignmentFiles AssignmentFile[]
  submissions     Submission[]

  @@index([teacherSubjectId])
  @@index([dueDate])
  @@index([isPublished])
  @@map("assignments")
}

// =====================================================
// ASSIGNMENT_FILES
// =====================================================

/// Files attached to assignments by teachers
model AssignmentFile {
  id           Int      @id @default(autoincrement())
  assignmentId Int      @map("assignment_id")
  fileName     String   @map("file_name") @db.VarChar(255)
  fileUrl      String   @map("file_url") @db.VarChar(500)
  fileType     String?  @map("file_type") @db.VarChar(50)
  fileSize     Int?     @map("file_size")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@map("assignment_files")
}

// =====================================================
// SUBMISSIONS
// =====================================================

/// Student submissions for assignments
model Submission {
  id            Int              @id @default(autoincrement())
  assignmentId  Int              @map("assignment_id")
  studentId     Int              @map("student_id")
  studentClassId Int             @map("student_class_id")
  schoolId      Int              @default(1) @map("school_id")
  content       String?          @db.Text
  status        SubmissionStatus @default(submitted)
  marksObtained Decimal?         @map("marks_obtained") @db.Decimal(5, 2)
  feedback      String?          @db.Text
  gradedBy      Int?             @map("graded_by")
  submittedAt   DateTime         @default(now()) @map("submitted_at")
  gradedAt      DateTime?        @map("graded_at")
  createdAt     DateTime         @default(now()) @map("created_at")

  // Relations
  assignment      Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentClass    StudentClass     @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  gradedByUser    User?            @relation("GradedBy", fields: [gradedBy], references: [id], onDelete: SetNull)
  submissionFiles SubmissionFile[]

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([studentClassId])
  @@index([status])
  @@index([gradedBy])
  @@index([schoolId])
  @@map("submissions")
}

// =====================================================
// SUBMISSION_FILES
// =====================================================

/// Files attached to student submissions
model SubmissionFile {
  id           Int      @id @default(autoincrement())
  submissionId Int      @map("submission_id")
  fileName     String   @map("file_name") @db.VarChar(255)
  fileUrl      String   @map("file_url") @db.VarChar(500)
  fileType     String?  @map("file_type") @db.VarChar(50)
  fileSize     Int?     @map("file_size")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("submission_files")
}

// =====================================================
// NOTICES
// =====================================================

/// School notices/announcements with granular targeting
model Notice {
  id          Int              @id @default(autoincrement())
  schoolId    Int              @map("school_id")
  createdById Int              @map("created_by_id")
  
  // Content
  title       String           @db.VarChar(255)
  content     String           @db.Text
  
  // Targeting
  targetType  NoticeTargetType @default(GLOBAL) @map("target_type")
  
  // Metadata
  priority    NoticePriority   @default(normal)
  status      NoticeStatus     @default(DRAFT)
  
  // Publish window (null = no restriction)
  publishFrom DateTime?        @map("publish_from")
  publishTo   DateTime?        @map("publish_to")
  
  // Audit timestamps
  publishedAt DateTime?        @map("published_at")
  archivedAt  DateTime?        @map("archived_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  school       School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy    User                @relation("NoticeCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  roleTargets  NoticeRoleTarget[]
  classTargets NoticeClassTarget[]
  attachments  NoticeAttachment[]

  @@index([schoolId, status])
  @@index([schoolId, targetType])
  @@index([schoolId, status, publishFrom, publishTo])
  @@index([createdById])
  @@index([priority])
  @@map("notices")
}

/// Which roles can see a ROLE_SPECIFIC notice
model NoticeRoleTarget {
  id        Int      @id @default(autoincrement())
  noticeId  Int      @map("notice_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([noticeId, roleId])
  @@index([noticeId])
  @@index([roleId])
  @@map("notice_role_targets")
}

/// Which classes/sections can see a CLASS_SPECIFIC notice
model NoticeClassTarget {
  id             Int      @id @default(autoincrement())
  noticeId       Int      @map("notice_id")
  classId        Int      @map("class_id")
  sectionId      Int?     @map("section_id")
  academicYearId Int      @map("academic_year_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  notice       Notice       @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  section      Section?     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([noticeId, classId, sectionId, academicYearId])
  @@index([noticeId])
  @@index([classId])
  @@index([sectionId])
  @@index([academicYearId])
  @@map("notice_class_targets")
}

/// File attachments for notices
model NoticeAttachment {
  id         Int      @id @default(autoincrement())
  noticeId   Int      @map("notice_id")
  fileName   String   @map("file_name") @db.VarChar(255)
  filePath   String   @map("file_path") @db.VarChar(500)
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type") @db.VarChar(100)
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  notice Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  @@index([noticeId])
  @@map("notice_attachments")
}

// =====================================================
// PROMOTIONS
// =====================================================

/// Student promotion/detention/graduation records
model Promotion {
  id                 Int             @id @default(autoincrement())
  studentId          Int             @map("student_id")
  fromClassId        Int             @map("from_class_id")
  fromAcademicYearId Int             @map("from_academic_year_id")
  toClassId          Int?            @map("to_class_id")
  toAcademicYearId   Int             @map("to_academic_year_id")
  status             PromotionStatus
  remarks            String?         @db.Text
  processedBy        Int             @map("processed_by")
  processedAt        DateTime        @default(now()) @map("processed_at")
  createdAt          DateTime        @default(now()) @map("created_at")

  // Relations
  student          Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  fromClass        Class        @relation("FromClass", fields: [fromClassId], references: [id], onDelete: Restrict)
  fromAcademicYear AcademicYear @relation("FromYear", fields: [fromAcademicYearId], references: [id], onDelete: Restrict)
  toClass          Class?       @relation("ToClass", fields: [toClassId], references: [id], onDelete: Restrict)
  toAcademicYear   AcademicYear @relation("ToYear", fields: [toAcademicYearId], references: [id], onDelete: Restrict)
  processedByUser  User         @relation("ProcessedBy", fields: [processedBy], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([fromAcademicYearId])
  @@index([toAcademicYearId])
  @@index([status])
  @@index([processedBy])
  @@map("promotions")
}

// =====================================================
// REFRESH_TOKENS (For JWT Auth)
// =====================================================

// =====================================================
// FEE MODULE
// =====================================================

/// Master list of fee categories per school
model FeeType {
  id            Int      @id @default(autoincrement())
  schoolId      Int      @map("school_id")
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  createdByUserId Int?   @map("created_by_user_id")
  updatedByUserId Int?   @map("updated_by_user_id")
  actorRole     String?  @map("actor_role") @db.VarChar(50)

  // Relations
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdByUser User?          @relation("FeeTypeCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUser User?          @relation("FeeTypeUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  feeStructures FeeStructure[]

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([isActive])
  @@index([createdByUserId])
  @@map("fee_types")
}

/// Fee amounts per class per academic year
model FeeStructure {
  id              Int      @id @default(autoincrement())
  schoolId        Int      @map("school_id")
  feeTypeId       Int      @map("fee_type_id")
  classId         Int      @map("class_id")
  academicYearId  Int      @map("academic_year_id")
  amount          Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdByUserId Int?     @map("created_by_user_id")
  updatedByUserId Int?     @map("updated_by_user_id")
  actorRole       String?  @map("actor_role") @db.VarChar(50)

  // Relations
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  feeType      FeeType      @relation(fields: [feeTypeId], references: [id], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  createdByUser User?       @relation("FeeStructureCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUser User?       @relation("FeeStructureUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  feePayments  FeePayment[]

  @@unique([feeTypeId, classId, academicYearId])
  @@index([schoolId])
  @@index([feeTypeId])
  @@index([classId])
  @@index([academicYearId])
  @@index([classId, academicYearId])
  @@index([createdByUserId])
  @@map("fee_structures")
}

/// Payment records linked to student enrollment
model FeePayment {
  id              Int           @id @default(autoincrement())
  schoolId        Int           @map("school_id")
  studentClassId  Int           @map("student_class_id")
  feeStructureId  Int           @map("fee_structure_id")
  amountDue       Decimal       @map("amount_due") @db.Decimal(10, 2)
  amountPaid      Decimal       @default(0) @map("amount_paid") @db.Decimal(10, 2)
  status          PaymentStatus @default(pending)
  paymentDate     DateTime?     @map("payment_date") @db.Date
  receiptNumber   String?       @map("receipt_number") @db.VarChar(50)
  paymentMethod   String?       @map("payment_method") @db.VarChar(50)
  remarks         String?       @db.Text
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  createdByUserId Int?          @map("created_by_user_id")
  updatedByUserId Int?          @map("updated_by_user_id")
  recordedByUserId Int?         @map("recorded_by_user_id")
  actorRole       String?       @map("actor_role") @db.VarChar(50)

  // Relations
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentClass   StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  createdByUser  User?        @relation("FeePaymentCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUser  User?        @relation("FeePaymentUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  recordedByUser User?        @relation("FeePaymentRecordedBy", fields: [recordedByUserId], references: [id], onDelete: SetNull)

  @@unique([studentClassId, feeStructureId])
  @@index([schoolId])
  @@index([studentClassId])
  @@index([feeStructureId])
  @@index([status])
  @@index([paymentDate])
  @@index([recordedByUserId])
  @@map("fee_payments")
}

// =====================================================
// PROGRAMS (NEB +2 Faculty Grouping - Grade 11-12 Only)
// =====================================================

/// Program/Faculty grouping for Grade 11-12 (Science, Management, Humanities)
/// Used for subject grouping, student assignment, and reporting
model Program {
  id             Int      @id @default(autoincrement())
  schoolId       Int      @map("school_id")
  academicYearId Int      @map("academic_year_id")
  name           String   @db.VarChar(100) // Science, Management, Humanities, etc.
  description    String?  @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  programSubjects ProgramSubject[]
  studentPrograms StudentProgram[]

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId])
  @@index([academicYearId])
  @@index([isActive])
  @@map("programs")
}

/// Links subjects to programs - defines which subjects belong to a program
model ProgramSubject {
  id             Int      @id @default(autoincrement())
  programId      Int      @map("program_id")
  classSubjectId Int      @map("class_subject_id")
  isCompulsory   Boolean  @default(true) @map("is_compulsory")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  program      Program      @relation(fields: [programId], references: [id], onDelete: Cascade)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)

  @@unique([programId, classSubjectId])
  @@index([programId])
  @@index([classSubjectId])
  @@map("program_subjects")
}

/// Assigns students to programs - one program per student enrollment
model StudentProgram {
  id             Int      @id @default(autoincrement())
  studentClassId Int      @unique @map("student_class_id")
  programId      Int      @map("program_id")
  assignedAt     DateTime @default(now()) @map("assigned_at")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  studentClass StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  program      Program      @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([studentClassId])
  @@index([programId])
  @@map("student_programs")
}

/// Specific subjects a student is taking (e.g. for Grade 11/12 overrides)
model StudentSubject {
  id             Int      @id @default(autoincrement())
  studentClassId Int                  @map("student_class_id")
  classSubjectId Int                  @map("class_subject_id")
  status         StudentSubjectStatus @default(ACTIVE)
  createdAt      DateTime             @default(now()) @map("created_at")

  // Relations
  studentClass StudentClass @relation(fields: [studentClassId], references: [id], onDelete: Cascade)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)

  @@unique([studentClassId, classSubjectId])
  @@index([studentClassId])
  @@index([classSubjectId])
  @@map("student_subjects")
}

// =====================================================
// SUBJECT_AUDIT (Audit Trail for Subject Changes)
// =====================================================

/// Tracks changes to subjects and class subjects for audit purposes
model SubjectAudit {
  id               Int                @id @default(autoincrement())
  classSubjectId   Int?               @map("class_subject_id")
  subjectId        Int?               @map("subject_id")
  action           SubjectAuditAction
  oldValue         Json?              @map("old_value")
  newValue         Json?              @map("new_value")
  performedByUserId Int               @map("performed_by_user_id")
  createdAt        DateTime           @default(now()) @map("created_at")

  @@index([classSubjectId])
  @@index([subjectId])
  @@index([performedByUserId])
  @@index([action])
  @@map("subject_audits")
}

// =====================================================
// REFRESH_TOKENS (For JWT Auth)
// =====================================================

/// JWT refresh tokens for authentication
model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @db.VarChar(500)
  userAgent String?  @map("user_agent") @db.VarChar(255)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  revokedAt DateTime? @map("revoked_at")
  replacedByTokenId Int? @map("replaced_by_token_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@index([token(255)])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("refresh_tokens")
}
